<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Report - HealthEase</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">

    <style>
        /* Report Page Specific CSS */
        body { background-color: #f8f9fa; }
        .report-container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }

        .report-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; background: white; padding: 20px;
            border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-left: 5px solid #007bff;
        }
        .report-header h1 { font-size: 24px; color: #1e293b; margin: 0; font-weight: 600; }

        .report-controls button {
            background: #007bff; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer;
            font-weight: 500; transition: 0.3s;
        }
        .report-controls button:hover { background: #0056b3; }

        .table-responsive {
            background: white; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        thead { background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        th, td { padding: 16px 20px; text-align: left; font-size: 14px; vertical-align: middle; }
        th { font-weight: 600; color: #64748b; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; }
        tr { border-bottom: 1px solid #e2e8f0; transition: background 0.2s; }
        tr:hover { background-color: #f8fafc; }

        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: capitalize; }
        .status-confirmed { background-color: #dcfce7; color: #166534; }
        .status-pending { background-color: #fef9c3; color: #854d0e; }
        .status-cancelled { background-color: #fee2e2; color: #991b1b; }

        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #e2e8f0; }

        .action-btn {
            background: none; border: none; cursor: pointer;
            color: #94a3b8; font-size: 16px; margin: 0 5px;
            transition: 0.2s; padding: 5px;
        }
        .action-btn:hover { color: #007bff; }
        .delete-btn:hover { color: #ef4444; }
    </style>
</head>
<body>

    <header style="background: white; padding: 15px 0; border-bottom: 1px solid #e2e8f0;">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <div class="logo" style="font-size: 22px; font-weight: 700; color: #1e293b;">
                <i class="fas fa-user-shield" style="color: #007bff;"></i> HealthEase <span style="color: #64748b; font-weight: 400; font-size: 18px;">| Admin Panel</span>
            </div>
            <nav>
                <a href="admin_panel.html" style="text-decoration: none; color: #64748b; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </nav>
        </div>
    </header>

    <div class="report-container">
        <div class="report-header">
            <div>
                <h1>All Appointments</h1>
                <p style="color: #64748b; font-size: 14px; margin-top: 5px;">View and manage patient bookings</p>
            </div>
            <div class="report-controls">
                <button onclick="window.print()"><i class="fas fa-print"></i> Print Report</button>
            </div>
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Booking ID</th>
                        <th>Patient Name</th>
                        <th>Assigned Doctor</th>
                        <th>Date & Time</th>
                        <th>Symptoms</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="appointmentTableBody">
                    <tr><td colspan="7" style="text-align:center;">Loading appointments...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:3000/api';

        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAuth();
            fetchAppointments();
        });

        // 1. Check Admin Auth
        function checkAdminAuth() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || user.role !== 'admin') {
                alert("⚠️ Access Denied! Redirecting to home.");
                window.location.href = 'index.html';
            }
        }

        // 2. Fetch Appointments
        async function fetchAppointments() {
            const tbody = document.getElementById('appointmentTableBody');
            const token = localStorage.getItem('token');

            try {
                // Fetch from LocalStorage (Fail-safe) + Backend
                let appointments = JSON.parse(localStorage.getItem('myBookedAppointments')) || [];

                // Try backend fetch if available
                try {
                    const res = await fetch(`${API_BASE}/appointments`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if(res.ok) {
                        const data = await res.json();
                        // Merge or use backend data
                        if(data.appointments && data.appointments.length > 0) {
                            appointments = data.appointments;
                        }
                    }
                } catch(e) { console.log("Using Local Data"); }

                if (appointments.length > 0) {
                    tbody.innerHTML = appointments.map(appt => {
                        
                        // ✅ SAFETY CHECKS (Date, Time, Symptoms)
                        const safeDate = appt.date ? appt.date : '<span style="color:#ef4444">Date Missing</span>';
                        const safeTime = appt.time ? appt.time : '';
                        const safeSymptoms = appt.symptoms ? appt.symptoms : '<i>No symptoms listed</i>';
                        const safePatient = appt.patientName || 'Unknown Patient';
                        const safeDoctor = appt.doctorName || 'Not Assigned';
                        const safeStatus = appt.status || 'Pending';
                        const safeId = appt.paymentId || appt.id || 'N/A';

                        return `
                        <tr>
                            <td style="font-weight: 600; color: #007bff;">#${safeId}</td>
                            <td>
                                <div style="font-weight: 500; color: #334155;">${safePatient}</div>
                            </td>
                            <td>
                                <div class="user-info">
                                    <img src="https://ui-avatars.com/api/?name=${safeDoctor}" class="user-avatar" alt="doc">
                                    <span style="font-weight: 500; font-size: 13px;">${safeDoctor}</span>
                                </div>
                            </td>
                            <td>
                                <div style="font-weight: 500; font-size: 13px;">${safeDate}</div>
                                <div style="font-size: 12px; color: #94a3b8;">${safeTime}</div>
                            </td>
                            <td style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #64748b;">
                                ${safeSymptoms}
                            </td>
                            <td>
                                <span class="status-badge status-${safeStatus.toLowerCase()}">${safeStatus}</span>
                            </td>
                            <td>
                                <button class="action-btn delete-btn" title="Delete" onclick="deleteAppointment('${safeId}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `}).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No appointments found.</td></tr>';
                }

            } catch (err) {
                console.error("Fetch Error:", err);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">Failed to load data.</td></tr>';
            }
        }

        // 3. Delete Appointment
        async function deleteAppointment(id) {
            if(!confirm('Are you sure you want to delete this appointment?')) return;
            
            // Remove from Local Storage (Immediate Effect)
            let appointments = JSON.parse(localStorage.getItem('myBookedAppointments')) || [];
            appointments = appointments.filter(appt => appt.paymentId !== id && appt.id !== id);
            localStorage.setItem('myBookedAppointments', JSON.stringify(appointments));
            
            alert('Appointment removed.');
            fetchAppointments(); // Refresh list
        }
    </script>
</body>
</html>